<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        
        <link type="text/css" href="/css/normalize.css" rel="stylesheet" />
        <link type="text/css" href="/css/foundation.min.css" rel="stylesheet" />
                    
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone-localstorage.js/1.1.16/backbone.localStorage-min.js"></script>
        <title>Интервью с клиентом</title>
        <style>
            li {
                cursor: pointer;
            }
        </style>

        <script type="text/template" id="questions">
        <div class="row medium-uncollapse large-collapse">
            <div class="row">
                <div class="small-3 columns">
                    <a href="#!start/" class="button tiny">Сначала</a>
                    <a href="#!start/" id="save" class="button tiny">Сохранить</a>
                </div>
            </div>
            <div class="row panel">
                <div class="large-10 large-offset-2 columns">    
                        <h5>Вопрос</h5>
                </div>
                <div class="small-6 small-centered columns">
                <%var q = questions.get(p.q_id)%>
                <%=q.get("content").replace(/User/g, u.get("name")).replace(/Client/g, c.get("name"))%></div>
                
                <div class="large-10 large-offset-2 columns">    
                        <h5>Ответы</h5>
                </div>
                <div class="row" id="answears_1" >
                    <div class="large-9 large-offset-3 columns">
                        <a id="yes" href="#" class="button tiny success">Да</a>
                        <a id="no" href="#" class="button tiny secondary">Нет</a>    
                    </div>
                </div>
                <div class="row" id="answears_2" style="display:none">
                    <%_.each(q.get("answears"), function (a) {%>
                        <div class="large-9 large-offset-3 columns">
                            <input type="<%=q.getType()%>" id="<%=a.id%>" name="answears" value="<%=a.id%>"><label for="<%=a.id%>"><%=a.get("content")%></label>
                        </div>
                    <%})%>
                </div>
                <div class="row" id="answears_3" style="display:none">
                    <div class="large-9 large-offset-3 columns">
                        <span class="success round label">Ура! Спрашиваем дальше!</span>
                    </div>
                </div>
                <div class="row" id="answears_4" style="display:none">
                    <div class="large-9 large-offset-3 columns">
                        <span class="secondary round label">Ну вот! =(</span>
                        <a href="" id="abort" class="button secondary">Закончить</a>
                    </div>
                </div>
            </div>
            <%var another_q;%>
            <div class="row">
                <div class="small-6 columns text-center">
                    <% if ((another_q = questions.get(p.q_id).getRelative(-1)) != undefined) {%>
                        <a href="#!questions/<%=another_q.id%>/" class="button radius centered nav">Предидущий</a>
                    <% } %>
                </div>
                <div class="small-6 columns text-center">
                    <% if ((another_q = questions.get(p.q_id).getRelative(1)) != undefined) {%>
                        <a href="#!questions/<%=another_q.id%>/" class="button radius centered nav next">Следующий</a>
                    <% } %>
                </div>
            </div>
        </div>   
        </script>
        
        <script type="text/template" id="start">
        <div class="row medium-uncollapse large-collapse">
          <div class="row">
            <div class="small-6 small-centered columns">
              <label>Вы представляетесь
                <input id="user_name" type="text" placeholder="" value="<%=u.get('name')%>" />
              </label>
            </div>
          </div>
          <div class="row">
            <div class="small-6 small-centered columns">
              <label>Берете интервью у клиента
                <input id="client_name" type="text" placeholder="Имя клиента" value="<%=c.get('name')%>" />
              </label>
            </div>
          </div>
            <div class="small-12 small-centered columns text-center">
                <a href="#!questions/" class="button radius nav start">Начать интервью</a>
            </div>
        </div>   
        </script>

        <script>
            var APP = {
                View_state: Backbone.Model.extend({
                    defaults: {
                        state: null,
                        params: null
                    },
                }),

                Router: Backbone.Router.extend({

                    initialize: function (options) {
                        $.extend(this, options);
                    },

                    routes: {
                        "!questions/(:id/)": "show_questions",
                        "!start/": "show_start",
                    },

                    show_questions: function (id) {
                        this.view_state.set({
                            state: "questions",
                            params: {
                                q_id: id,
                            }
                        });
                    },
                    
                    show_start: function () {
                        this.view_state.set({
                            state: "start"
                        });
                    },
                    
                    url_generators: {
                        questions: function (vs) {
                            var id = vs.get("params").q_id;
                            return "!questions/" + (id != null ? (id + "/") : "");
                        },
                        start: function () {
                            return "!start/"
                        }
                    },

                    generate_url: function() {
                        var vs = this.view_state;
                        return this.url_generators[vs.get("state")](vs);
                    },

                    current : function() {
                        var Router = this,
                                fragment = Backbone.history.fragment,
                                routes = _.pairs(Router.routes),
                                route = null, params = null, matched;

                        matched = _.find(routes, function(handler) {
                            route = _.isRegExp(handler[0]) ? handler[0] : Router._routeToRegExp(handler[0]);
                            return route.test(fragment);
                        });

                        if(matched) {
                            // NEW: Extracts the params using the internal
                            // function _extractParameters
                            params = Router._extractParameters(route, fragment);
                            route = matched[1];
                        }

                        return {
                            route : route,
                            fragment : fragment,
                            params : params
                        };
                    }
                }),

                View_logic: Backbone.View.extend({
                    el: "#wrapper",

                    initialize: function (options) {
                        $.extend(this, options);
                        
                        var AModel = Backbone.Model.extend({});
                        var ACollection = Backbone.Collection.extend({
                            model: AModel,
                            url: '/?controller=interview&action=get_answears',
                        });
                        
                        var QModel = Backbone.Model.extend({
                            defaults: {
                                answears: [],
                                types: ["radio", "checkbox"]
                            },
                            getType: function() {
                                return this.get("types")[this.get("type")];
                            },
                            getRelative: function(direction) {
                                return this.collection.at(this.collection.indexOf(this) + direction);
                            }
                        });
                        var QCollection = Backbone.Collection.extend({
                            model: QModel,
                            url: '/?controller=interview&action=get_questions',
                            add_answears: function (answs) {
                                var self = this;
                                this.each(function (q) {
                                    q.set({answears: []});
                                })
                                answs.each(function (a) {
                                    self.get(a.get("question_id")).get("answears").push(a);
                                })
                            }
                        });
                        
                        var UserModel = Backbone.Model.extend({
                            //localStorage: new Backbone.LocalStorage("user"),
                            url: '/?controller=users&action=get_current',
                        });
                        
                        var ClientModel = Backbone.Model.extend({
                            //localStorage: new Backbone.LocalStorage("client")
                        });

                        var InterviewModel = Backbone.Model.extend({
                            //localStorage: new Backbone.LocalStorage("client")
                            defaults: {
                                question: null,
                                answear: null,
                            },
                        });
                        var InterviewCollection = Backbone.Collection.extend({
                            model: InterviewModel,
                            id: 1,
                            url: '/?controller=interview&action=save_interview',
                            save: function() {
                                Backbone.sync('create', this, {
                                    success: function() {
                                        console.log('Saved!');
                                    }
                                });
                            }
                            //save_local: function(){
                            //    Backbone.sync('update', this, {});
                            //},
                            //localStorage: new Backbone.LocalStorage("interview")
                        });

                        this.question_list = new QCollection();
                        this.answears_list = new ACollection();
                        this.inteview = new InterviewCollection();
                        //this.inteview.fetch();
                        this.user = new UserModel({id: 1});
                        //this.user.fetch();
                        this.client = new ClientModel({id: 1});
                        //this.client.fetch();
                        this.view_state.bind('change', this.refresh, this);
                        //this.interview.bind('add remove', this.refresh, this);
                    },
                    
                    saveInterviewState: function () {
                        var searchIDs = $("input:checkbox:checked").map(function(){
                            return $(this).val();
                        }).get();
                        if (searchIDs.length === 0)
                            searchIDs.push(0);
                        this.inteview.add({
                            question: this.view_state.get('params').q_id,
                            answear: searchIDs
                        });
                    },
                    
                    saveInterview: function () {
                        this.inteview.save();
                    },

                    events: {
                        'click .nav' : function () {
                            //this.inteview.save_local();
                        },
                        
                        'click .next' : function () {
                            this.saveInterviewState();
                        },
                        
                        'click .start' : function () {
                            this.user.set({name: $("#user_name").val()});
                            this.client.set({name: $("#client_name").val()});
                            //this.user.save_local();
                            //this.client.save_local();
                        },
                        'click #yes' : function (event) {
                            event.preventDefault();
                            $("#answears_1").hide();
                            $("#answears_3").show();
                        }, 
                        'click #no' : function (event) {
                            event.preventDefault();
                            $("#answears_1").hide();
                            $("#answears_" + 
                                (this.question_list.get(this.view_state.get('params').q_id).get("answears").length !== 0 ?
                                "2" :
                                "4")
                            ).show();     
                        }, 
                        
                        'click #abort' : function (event) {
                            event.preventDefault();
                            this.inteview.add({
                                question: this.view_state.get('params').q_id,
                                answear: -1
                            });
                            this.saveInterview();
                        }, 
                        'click #save' : function (event) {
                            event.preventDefault();
                            this.saveInterviewState();
                            this.saveInterview();
                        }, 
                    },
                    
                

                    refresh: function () {
                        var self = this;
                        self.user.fetch({
                            dataType: "json",
                            success: function(data) {
                                switch(self.view_state.get("state")) {
                                    case "questions":
                                        self.question_list.fetch({
                                            dataType: "json",
                                            success: function(data) {
                                                if (self.view_state.get("params").q_id === null)
                                                    self.view_state.get("params").q_id = data.first().get("id");
                                                self.answears_list.fetch({
                                                    dataType: "json",
                                                    success: function(data) {
                                                        self.question_list.add_answears(data);
                                                        self.render({questions: self.question_list, c: self.client});
                                                    },
                                                    error: function() {
                                                        console.log('error');
                                                    }
                                                });                                              
                                                console.log('success');
                                            },
                                            error: function() {
                                                console.log('error');
                                            }
                                        });
                                        break;
                                    case "start":
                                        self.render({c: self.client});
                                        break;
                                    default: 
                                        self.render({});
                                        break;
                                }
                            },
                            error: function() {
                                location.href = "/";
                                console.log('error');
                            }
                        });
                    },

                    render: function(params){
                        $(this.el).html(
                            _.template($('#' + this.view_state.get('state')).html())($.extend(params, {p: this.view_state.get('params')}, {u: this.user})) 
                        );

                        return this;
                    },

                    start: function (default_url) {
                        var current = this.router.current();
                        this.router.navigate(current.params != null ? current.fragment : default_url, {trigger: true});
                    }
                }),

                display : function () {
                    var self = this;

                    var view_state = new self.View_state();
                    var router = new self.Router({ view_state: view_state });

                    view_state.bind("change", function () {
                        router.navigate(router.generate_url());
                    });

                    var view = new self.View_logic({
                        view_state: view_state,
                        router: router,
                    });

                    Backbone.history.start();
                    view.start('!start/');
                }
            }

            $(function() {
                APP.display();
            });
        </script>
    </head>
    <body>
    <div id="wrapper"></div>
    </body>
</html>