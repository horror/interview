<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        
        <link type="text/css" href="/vendors/css/foundation.min.css" rel="stylesheet" />
        <link type="text/css" href="/vendors/css/normalize.css" rel="stylesheet" />
        <link type="text/css" href="/vendors/css/foundation-datepicker.min.css" rel="stylesheet" />
        <link type="text/css" href="/css/custom.css" rel="stylesheet" />
                    
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.2.3/backbone-min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone-localstorage.js/1.1.16/backbone.localStorage-min.js"></script>
        <script src="/vendors/js/foundation-datepicker.min.js"></script>
        
        <script src="/vendors/js/jquery.flot.js"></script>
        <script src="/vendors/js/jquery.flot.axislabels.js"></script>
        <script src="/vendors/js/jquery.flot.pie.js"></script>
        
        <script src="/js/interview_app.js"></script>
        <script src="/js/utils.js"></script>
        <script src="/js/charts.js"></script>
        <script src="/js/config.js"></script>
        <title>Опросник v1.0</title>

        <script type="text/template" id="top_menu">
        <nav class="top-bar" data-topbar role="navigation">
            <ul class="title-area">
              <li class="name">
                <h1><a href="/">Опросник v1.0</a></h1>
            </ul>

            <section class="top-bar-section">
              <!-- Right Nav Section -->
              <ul class="right">
                <li><span class="<%=interview_cnt > 0 ? 'success' : ''%> label">Количество опросов за сегодня: <%=interview_cnt%></span></a>
                <li><a href="/?controller=users&action=logout">Выход</a>
              </ul>

              <!-- Left Nav Section -->
              <ul class="left">
                <%_.each(menu, function (title, href) {%>
                    <li><a href="<%=href%>"><%=title%></a></li>
                <%})%>
              </ul>
            </section>
          </nav>
        </script>
        
        <script type="text/template" id="questions">
        <%var q = questions.get(p.q_id)%>
        <div class="row medium-uncollapse large-collapse panel callout">
            <div class="row" id="menu">
                <div class="small-3 columns">
                    <a href="#!start/" class="button tiny">Сначала</a>
                    <a href="#!start/" id="save" class="button tiny">Сохранить</a>
                </div>
            </div>
            <div class="row panel" id="question_last" style="display:none">
                <div class="small-6 small-centered columns">
                    <%=c.get("name")%>, спасибо за участие в опросе, ваше мнение очень важно для нас! Ждем вас в наших магазинах. Всего доброго, до свидания!
                </div>
            </div>
            <div class="row panel" id="question">
                <div class="large-10 large-offset-2 columns">    
                        <h4><%=q.get_category_name()%></h4>
                </div>
                <div class="large-10 large-offset-2 columns">    
                        <h5>Вопрос</h5>
                </div>
                <div class="small-6 small-centered columns">
                    <%=q.get("content").replace(/User/g, u.get("name")).replace(/Client/g, c.get("name"))%>
                    <%if (interview.meta.answers_type*1 && q.get("answers").length > 0) {%>
                        Оцените, пожалуйста, по 10 бальной шкале.
                    <%}%>
                </div>
                
                <div class="large-10 large-offset-2 columns">    
                        <h5>Ответы</h5>
                </div>
                <%if (interview.meta.answers_type*1 && q.get("answers").length > 0) {%>
                    <div class="row" id="answers_1_score" >
                        <div class="large-9 large-offset-3 columns">
                            <input type="radio" id="score_1" value="1" name="score" class="score"><label for="score_1">1</label>
                            <input type="radio" id="score_2" value="2" name="score" class="score"><label for="score_2">2</label>    
                            <input type="radio" id="score_3" value="3" name="score" class="score"><label for="score_3">3</label>    
                            <input type="radio" id="score_4" value="4" name="score" class="score"><label for="score_4">4</label>    
                            <input type="radio" id="score_5" value="5" name="score" class="score"><label for="score_5">5</label>    
                            <input type="radio" id="score_6" value="6" name="score" class="score"><label for="score_6">6</label>    
                            <input type="radio" id="score_7" value="7" name="score" class="score"><label for="score_7">7</label>   
                            <input type="radio" id="score_8" value="8" name="score" class="score"><label for="score_8">8</label>    
                            <input type="radio" id="score_9" value="9" name="score" class="score"><label for="score_9">9</label>    
                            <input type="radio" id="score_10" value="10" name="score" class="score"><label for="score_10">10</label> 
                        </div>
                    </div>
                <%} else {%>
                    <div class="row" id="answers_1" >
                        <div class="large-9 large-offset-3 columns">
                            <a id="yes" href="#" class="button tiny success">Да</a>
                            <a id="no" href="#" class="button tiny secondary">Нет</a>    
                        </div>
                    </div>
                <%}%>
                <div class="row" id="answers_2" style="display:none">
                    <%_.each(q.get("answers"), function (a) {%>
                        <div class="large-9 large-offset-3 columns">
                            <input type="checkbox" id="<%=a.id%>" name="answers" value="<%=a.id%>"><label for="<%=a.id%>"><%=a.get("content")%></label>
                        </div>
                    <%})%>
                    <div class="large-9 large-offset-3 columns">
                        <label for="other_answer">Другое</label><input type="text" id="other_answer">
                    </div>
                </div>
                <div class="row" id="answers_3" style="display:none">
                    <div class="large-9 large-offset-3 columns">
                        <span class="success round label">Ура! Вопросы закончились!</span>
                    </div>
                </div>
                <div class="row" id="answers_4" style="display:none">
                    <div class="large-9 large-offset-3 columns">
                        <span class="secondary round label">Ну вот! =(</span>
                        <a href="#!start/" id="abort" class="button secondary">Закончить</a>
                    </div>
                </div>
                <%if (interview_hash[q.id] != undefined) {%>
                    <div class="row" id="last_answer">
                        <%var ans = interview_hash[q.id].answer%>
                        <%var score = interview_hash[q.id].score%>
                        <div class="large-10 large-offset-2 columns">    
                            <h5>Последний ответ</h5>
                        </div>
                        <div class="large-9 large-offset-3 columns">
                            <%if (interview.meta.answers_type*1 && q.get("answers").length > 0) {%>
                                <span class="info label"><%=score%> очков</span>
                            <%} else {%>
                                <span class="<%=(ans[0] == 1) ? 'success' : 'secondary' %> label"><%=(ans[0] == 1) ? 'Да' : 'Нет' %></span>
                            <%}%>
                        </div>
                        <div class="large-9 large-offset-3 columns">
                            <ul>
                                <%_.each(ans, function (a) {%>
                                    <%if (a == 0) return;%>
                                    <li><%=answers.get(a).get('content')%></li>
                                <%})%>
                            </ul>
                        </div>
                    </div>
                <%}%>
            </div>
            <%var another_q;%>
            <div class="row">
                <div class="small-6 columns text-center">
                    <% if ((another_q = questions.get(p.q_id).get_relative(-1)) != undefined) {%>
                        <a href="#!questions/<%=another_q.id%>/" class="button radius centered nav prev">Предыдущий</a>
                    <% } %>
                </div>
                <div class="small-6 columns text-center">
                    <% if ((another_q = questions.get(p.q_id).get_relative(1)) != undefined) {%>
                        <a href="#!questions/<%=another_q.id%>/" class="button radius centered nav next">Следующий</a>
                    <% } else { %>
                        <a href="#!start/" class="button success radius centered nav last">Прощаться</a>
                    <% } %>
                </div>
            </div>
        </div>   
        </script>
        
        <script type="text/template" id="start">
        <form id="start_form">
        <div class="row medium-uncollapse large-collapse panel callout">
          <div class="row">
            <div class="small-6 small-centered columns" id="msg_block">
              
            </div>
          </div>
          <div class="row" style="display:none">
            <div class="large-4 columns">
              <label>Вы представляетесь
                <input id="user_name" type="text" placeholder="" value="<%=u.get('name')%>" />
              </label>
            </div>
          </div>
          <div class="row">
            <div class="small-6 small-centered columns">
              <label>Тип интервью
                <select id="answers_type">
                    <option value="0">Да/Нет</option>
                    <option value="1">Баллы</option>
                </select>
              </label>
            </div>
          </div>
          <div class="row">
            <div class="small-6 small-centered columns">
              <label>Дата обзвона
                <input id="calling_date" type="text" required/>
              </label>
            </div>
          </div>
          <div class="row">
            <div class="small-6 small-centered columns">
              <label>Набор вопросов
                <select id="question_categories">
                    <option value="0">Розница</option>
                    <option value="0,1">Розница+Доставка</option>
                    <option value="2">Интернет магазин</option>
                </select>
              </label>
            </div>
          </div>
          <div class="row">
            <div class="small-6 small-centered columns">
              <label>Оператор
                <select id="operator_type">
                    <option value="0">Оператор 1</option>
                    <option value="1">Оператор 2</option>
                </select>
              </label>
            </div>
          </div>
          <div class="row" id="shop_block">
            <div class="small-6 small-centered columns">
              <label>Магазин
                <select id="shop">
                </select>
              </label>
            </div>
          </div> 
          <div class="row">
            <div class="small-6 small-centered columns">
              <label>Берете интервью у клиента
                <input id="client_name" type="text" placeholder="Имя клиента" required />
              </label>
            </div>
          </div>
          <div class="row">
            <div class="small-6 small-centered columns">
              <label>Телефон
                <input id="client_phone" type="text" placeholder="+7-9XX-XX-XX-XX" value="" required />
              </label>
            </div>
          </div>
          <div class="row">
            <div class="small-6 small-centered columns">
              <label>№ реализации
                <input id="order_no" type="text" placeholder="" value="" required />
              </label>
            </div>
          </div>
          <div class="row" style="display:none">
            <div class="small-6 small-centered columns">
              <label>Товар
                <input id="product" type="text" placeholder="Стиральная машина" value="" />
              </label>
            </div>
          </div>
          <div class="small-12 small-centered columns text-center">
              <a href="#!questions/" class="button radius nav start">Начать интервью</a>
          </div>
        </div>   
        </form>
        </script>
        
        <script type="text/template" id="editor">
            <div class="row">
                <div class="large-9 columns panel">
                    <div class="row">
                        <div class="large-7 large-offset-2 columns">    
                            <h5>Вопрос</h5>
                        </div>
                    </div>
                    <div class="row">
                        <div class="large-6 large-centered columns">
                            <textarea id="question_text"></textarea>
                            <select id="question_category">
                                <option value="0">Розница</option>
                                <option value="1">Доставка</option>
                                <option value="2">Интернет магазин</option>
                            </select>
                        </div>
                        <div class="large-7 large-offset-2 columns">    
                            <h5>Ответы</h5>
                        </div>
                        <div class="large-9 large-offset-3 columns" id="answers_list">

                        </div>
                    </div>
                    <div class="row">
                        <div class="large-6 large-centered columns">

                             <input style="float:right" type="text" name="answers" id="answer_text" placeholder="вариант ответа">
                             <a href="#" class="button secondary tiny" id="answer_add">Добавить ответ</a>
                        </div>
                        <div class="small-12 small-centered columns text-center">
                            <a href="/#!editor/" class="button radius nav start" id="question_add">Добавить вопрос</a>
                        </div>
                    </div>
                </div>
                <div class="large-3 columns">
                    <%questions.each(function (q) {%>
                        <div class="panel callout radius">
                            <%=q.get("content")%>
                            <ul>
                            <%_.each(q.get("answers"), function (a) {%>
                                <li><%=a.get("content")%></li>
                            <%})%>
                            </ul>
                        </div>
                    <%})%>
                </div>
            </div>
        </script>
        
        <script type="text/template" id="stats">
        <div class="row">
            <div class="large-6 columns">
                <h2>Добавить новый график:</h2>
                <div class="box">
                    <div>
                        <label>Ось У</label>
                        <select id="parameter">
                            <option value="call_cnt">Колличество звонков</option>
                        </select>
                    </div>
                    <div>
                        <label>Ось Х</label>
                        <select id="group_by">
                            <%_.each(chart.group_by_labels, function (label, name) {
                            %>
                            <option value="<%=name%>"><%=label%></option>
                            <%
                            });%>
                        </select>
                    </div>
                    <div>
                        <label>Агрегация</label>
                        <select id="aggregation">
                            <option value="sum">Сумма</option>
                            <option value="avg">Среднее</option>
                            <option value="min">Минимум</option>
                            <option value="max">Максимум</option>
                        </select>
                    </div>
                    <div class="parameter_params" id="call_cnt_params">
                        <div>
                            <label>Тип опроса</label>
                            <div>
                                <input class="selector" type="checkbox" name="q_types" checked="checked" value="0" /><strong>ДА/НЕТ</strong>
                                <input class="selector" type="checkbox" name="q_types" checked="checked" value="1" /><strong>Баллы</strong>
                            </div>
                        </div>
                        <div>
                            <label>Категории вопросов</label>
                            <div id="q_categories">
                                <%
                                for(var c in chart.q_categories) {
                                %>
                                <input class="selector" name="q_categories" type="checkbox" value="<%=c%>" checked="checked" title="<%=chart.q_categories[c]%>"/><strong><%=chart.q_categories[c]%></strong>
                                <%
                                }
                                %>
                            </div>
                        </div>
                        <label>Завершенность</label>
                        <div>
                            <input class="selector" name="aborted" value="1" type="checkbox"/><strong>Отказ</strong>
                        </div>
                        <div>
                            <label>Оператор <input type="text" size="20" id="user" placeholder=".*?" value="<%//u.get('name')%>"></label>
                        </div>
                        <div>
                            <label>Магазин
                                <select id="shop">
                                </select>
                            </label>
                        </div>
                        
                    </div>
                    <div>
                        <label>Цвет</label>
                        <%
                        for(var i = 0; i < chart.colors.length; ++i) {
                        %>
                        <input class="selector" type="radio" name="color" value="<%=chart.colors[i]%>"><span style="background:<%=chart.colors[i]%>">[]</span>
                        <%
                        };
                        %>
                    </div>
                    <div><button id="add_series">Добавить</button></div>
                </div>
                <div>
                    <h2>Тип графика:</h2>
                    <select id="chart_type">
                        <option value="line">Координатная плоскость</option>
                        <option value="pie">Круговые диаграммы</option>
                        <option value="text">Текст</option>
                    </select>
                </div>
                <%if (chart.chart_type !== "pie") {%>
                <div class="plot_container"><div class="plot" id="plot"></div></div>
                <%}
                else for (var i = 0; i < chart.series.length; ++i) {
                //var pp = chart.series_params[i].problems;
                //var header = pp.length == 1 ? app.problems[pp[0]].name : "";
                %>

                <div class="pie large-6 columns"><div class="plot" id="plot_<%=i%>"></div></div>
                <%
                };
                %>
                <script>
                    $("#parameter").change(function () {
                        $(".parameter_params").css("display", "none");
                        $("#" + $("#parameter").val() + "_params").css("display", "block");
                    });
                    $("#chart_type").val("<%=chart.chart_type%>");
                    <%if (chart.chart_type === "line") {%>
                        $.plot("#plot", <%=JSON.stringify(chart.series)%>, {
                        series: {
                            bars: {
                                show: true,
                                lineWidth: 0, // in pixels
                                barWidth: 0.9, // in units of the x axis
                                align: "center", // "left", "right", or "center"
                                horizontal: false,
                                zero: true,
                            }
                        },
                        xaxes: [
                          { position: 'bottom', ticks: [
                              <%
                              var idx = 0;
                              _.each(chart.q_categories, function (cat) {
                              %>
                                [<%=idx++%>, "<%=cat%>"],
                              <%
                              });
                              %>
                          ], axisLabel: 'Категории вопросов' }
                        ],
                        yaxes: [
                            { position: 'left', axisLabel: 'Количество звонков' },
                        ],
                        legend: {
                            labelFormatter: function(label, series) {
                              return ' <a class="delete_series" data-series="' + series.id + '" href="#" onClick="return false;"> Удалить</a>';
                            }
                        }
                        });
                    <%}
                    else if (chart.chart_type === "pie") {%>
                        var series = <%=JSON.stringify(chart.series_pie_format())%>;
                        for(var i = 0; i < series.length; ++i) {
                            $.plot("#plot_" + i, series[i], {
                                series: {
                                    pie: {show: true}
                                },
                                legend: {
                                    show: false
                                }
                            });
                        }
                    <%} 
                    else {%>
                        $("#plot").html("<pre id='json'>" + UTILS.syntaxHighlight(JSON.stringify(<%=JSON.stringify(chart.series_pie_format())%>, null, 2)) + "</pre>");
                    <%}%>
                    $("#parameter").change();
                    $("#shop option").remove();
                    var shops_list = <%=JSON.stringify(_.union(settings.operator_shop_ref[0], settings.operator_shop_ref[1]))%>
                    _.each(shops_list.sort(function(a,b) {
                            return (+a) - (+b);
                        }), function (shop) {
                            $("#shop").append("\
                                <option value='" + shop + "'>СП-" + shop + "</option>"
                            );
                    })
                    $("#shop").val(-1).change();
                </script>
            </div>
        </div>
        </script>
    </head>
    <body>
    <div id="wrapper"></div>
    </body>
</html>